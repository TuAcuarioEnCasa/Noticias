<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de Filtro: Flujo - Rotación (L/h) - Material Filtrante (ml)</title>
<style>
  body{font-family:system-ui;margin:0;background:#041220;color:#e6eef6}
  .wrap{max-width:1100px;margin:20px auto;padding:18px}
  .card{background:#071827;border-radius:12px;padding:14px;margin-top:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  input,select{width:100%;padding:8px;border-radius:8px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.06)}
  table{width:100%;margin-top:8px;border-collapse:collapse}
  th,td{padding:6px;font-size:13px;color:inherit}
  .btn{background:#22c1c3;color:#042028;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .output{font-size:16px;font-weight:600;margin-top:4px}
  .fade-reset{animation:flash .5s ease}
  @keyframes flash{0%{background:#ffffff22;}100%{background:transparent;}}
  /* selects azul oscuro */
  select#speciesSelect, select#plantation, select#filterType, select#correction, select#feedFactor, select#safetyFactor, select#mediaType {
    background-color:#002a4d;
    color:#e6eef6;
    border:1px solid rgba(255,255,255,0.06);
    padding:8px;border-radius:8px;
  }
  .logo-superior {
  position: fixed;
  top: 10px;
  right: 10px;

  /* Tamaño responsivo */
  width: clamp(70px, 12vw, 150px);

  height: auto;
  z-index: 9999;
  pointer-events: none;
  object-fit: contain;
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.6));
}
</style>
</head>
<body>

<!-- inserción de imagen -->
<img src="logo_tu_acuario.png" alt="Logo" class="logo-superior">
<!-- fin inserción de imagen -->
<button id="resetBtn" class="btn" style="margin:12px">Reiniciar página</button>

<div class="wrap" id="wrapBox">
  <h2>Calculadora de Filtro: Flujo - Rotación(L/h) - Material Filtrante (ml)</h2>

  <!-- DIMENSIONES -->
  <div class="card">
    <h4>1) Dimensiones & volúmenes</h4>
    <div class="row">
      <div class="col"><label>Largo (cm)</label><input id="length" type="number" value="0"></div>
      <div class="col"><label>Ancho (cm)</label><input id="width" type="number" value="30"></div>
      <div class="col"><label>Alto (cm)</label><input id="height" type="number" value="0"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col"><label>Espesor sustrato (cm)</label><input id="substrate" type="number" value="0" step="0.1"></div>
      <div class="col"><label>Vol decoraciones (L)</label><input id="decor" type="number" value="0" step="0.1"></div>
    </div>
  </div>

  <!-- ESPECIES -->
  <div class="card">
    <h4>2) Especies (hasta 10)</h4>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <select id="speciesSelect"><option value="">-- Elige morfología --</option></select>
      <button id="addSpecies" class="btn">Agregar especie</button>
      <div style="margin-left:auto" class="mini">Los campos aparecen al agregar una especie.</div>
    </div>

    <table id="speciesTable">
      <thead><tr><th>Especie</th><th>Cant.</th><th>Long.(cm)</th><th>A</th><th>B</th><th>Biomasa (g)</th><th></th></tr></thead>
      <tbody id="speciesBody"></tbody>
    </table>
  </div>

  <!-- CONDICIONES -->
  <div class="card">
    <h4>3) Condiciones & ajustes</h4>
    <div class="row">
      <div class="col"><label>Temperatura (°C)</label><input id="temp" type="number" value="20" step="0.1"></div>
      <div class="col"><label>pH</label><input id="ph" type="number" value="0" step="0.1"></div>
      <div class="col"><label>Comidas por día</label><input id="meals" type="number" value="0" min="1"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Plantación</label><select id="plantation"><option value="">--Elige--</option><option>Sin plantación</option><option selected>Plantación moderada</option><option>Plantación intensiva</option></select></div>
      <div class="col"><label>Tipo de filtro</label><select id="filterType"><option value="">--Elige--</option><option>Canister</option><option>Cascada</option><option>Sump</option><option>Interno</option><option>Otro</option></select></div>
      <div class="col"><label>Altura elevación (cm) para Sump o Canister</label><input id="lift" type="number" value="0" min="0"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col"><label>Corrección: Factor para corregir perdidas de rendimiento del sistema (resistencia hidráulica, sobrecarga biológica, bajo caudal, mantenimiento, etc.)</label><select id="correction"><option>Sin Corrección</option><option>Corrección Moderada</option><option>Corrección Alta</option></select></div>
    </div>
  </div>


  <!-- NUEVA SECCIÓN: PARÁMETROS PARA SUPERFICIE BIOLÓGICA -->
  <div class="card">
    <h4>4) Parámetros para Superficie Biológica</h4>
    <div class="row">
      <div class="col"><label>Factor de alimentación</label>
        <select id="feedFactor">
          <option value="1">Normal (1)</option>
          <option value="1.3">Crecimiento rápido (1.3)</option>
          <option value="1.5">Alimentación agresiva (1.5)</option>
        </select>
      </div>
      <div class="col"><label>Margen de seguridad</label>
        <select id="safetyFactor">
          <option value="1">Mínimo (1)</option>
          <option value="1.5">Seguro (1.5)</option>
          <option value="2">Muy seguro (2)</option>
        </select>
      </div>
      <div class="col"><label>Tipo de medio biofiltrante</label>
        <select id="mediaType">
          <option value="700">Matrix (700 m²/L)</option>
          <option value="608">Home Ultimate (608 m²/L)</option>
          <option value="270">Sera Siporax (270 m²/L)</option>
          <option value="250">Canutillos cerámicos (250 m²/L)</option>
          <option value="140">Roca Volcánica (140 m²/L)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- RESULTADOS -->
  <div class="card">
    <h4>Resultados</h4>
    <div class="row">
      <div class="col"><div class="mini">Volumen bruto (L)</div><div id="volGross" class="output">-</div></div>
      <div class="col"><div class="mini">Volumen substr + decor (L)</div><div id="volSubstrate" class="output">-</div></div>
      <div class="col"><div class="mini">Volumen neto (L)</div><div id="volNet" class="output">-</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><div class="mini">Biomasa total (g)</div><div id="biomassTotal" class="output">-</div></div>
      <div class="col"><div class="mini">Biomasa g/L</div><div id="biomassPerL" class="output">-</div></div>
      <div class="col"><div class="mini">Factor base flujo (x)</div><div id="flowFactor" class="output">-</div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="col"><div class="mini">Flujo base (L/h)</div><div id="flowBase" class="output">-</div></div>
      <div class="col"><div class="mini">Flujo real recomendado (L/h)</div><div id="flowReal" class="output">-</div></div>
      <div class="col"><div class="mini">Rotaciones (Vn/h)</div><div id="rotations" class="output">-</div></div>
    </div>

    <div style="margin-top:10px" class="mini" id="observations">-</div>
  </div>

  <div class="card">
    <h4>Resultados Biológicos</h4>
    <div class="row">
      <div class="col"><div class="mini">Superficie biológica requerida (m²)</div><div id="bioSurface" class="output">-</div></div>
      <div class="col"><div class="mini">Volumen necesario de material filtrante (ml)</div><div id="bioVolume" class="output">-</div></div>
    </div>
  </div>

</div>

<script>
let allowValidation=false;

const presets = [
  {forma:"Alargado / Delgado",A:0.007,B:2.9},
  {forma:"Muy Alargado",A:0.00075,B:2.68},
  {forma:"Estándar /Torpedo",A:0.012,B:3.05},
  {forma:"Comprimido Lateralmente",A:0.0225,B:3.2},
  {forma:"Aplanado Dorso-Ventralmente",A:0.03,B:3.2},
  {forma:"Robusto / Redondeado",A:0.04,B:3.5},
  {forma:"Muy Robusto / Ovalado",A:0.03,B:3.3}
];

function populateSelect(){
  const sel=document.getElementById('speciesSelect');
  sel.innerHTML='<option value="">-- Elige morfología --</option>';
  presets.forEach((p,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.text=`${p.forma} — A=${p.A} B=${p.B}`;
    sel.appendChild(opt);
  });
}

let speciesCount=0;
const maxSpecies=10;

function addSpeciesRow(presetIndex){
  if(speciesCount>=maxSpecies) return alert("Máximo 10 especies alcanzado.");
  speciesCount++;
  const i = speciesCount;
  const tbody=document.getElementById('speciesBody');
  const tr=document.createElement('tr'); tr.id='row_'+i;
  tr.innerHTML=`
    <td><input type="text" id="name_${i}" placeholder="Nombre (opcional)" /></td>
    <td><input type="number" id="qty_${i}" value="1" min="0" step="1" /></td>
    <td><input type="number" id="len_${i}" value="0" min="0" step="0.1" /></td>
    <td><input type="number" id="A_${i}" step="0.00001" /></td>
    <td><input type="number" id="B_${i}" step="0.01" /></td>
    <td><div id="bio_${i}" class="mini">0</div></td>
    <td><button class="btn" onclick="removeRow('row_${i}')">Eliminar</button></td>
  `;
  tbody.appendChild(tr);

  // If a preset index was provided, populate A/B from presets
  if(presetIndex!=="" && presets[Number(presetIndex)]){
    document.getElementById(`A_${i}`).value=presets[Number(presetIndex)].A;
    document.getElementById(`B_${i}`).value=presets[Number(presetIndex)].B;
  } else {
    // leave blank so user must enter values
    document.getElementById(`A_${i}`).value = "";
    document.getElementById(`B_${i}`).value = "";
  }

  // add listeners to new inputs
  ['qty','len','A','B'].forEach(k=>{
    const el=document.getElementById(`${k}_${i}`);
    if(el){ el.addEventListener('input',recalc); el.addEventListener('change',recalc); }
  });

  // ensure immediate recalc
  queueMicrotask(recalc);
}

function removeRow(id){
  const el=document.getElementById(id);
  if(el) el.remove();
  const rows=document.querySelectorAll('[id^="row_"]');
  // re-index rows to keep speciesCount contiguous
  speciesCount = 0;
  let idx = 1;
  rows.forEach(r => {
    r.id = 'row_' + idx;
    // update internal ids of inputs inside the row to match new index
    const inputs = r.querySelectorAll('input, div, button, select');
    inputs.forEach(inp => {
      if(inp.id){
        const newId = inp.id.replace(/_(\d+)$/, '_' + idx);
        try { inp.id = newId; } catch(e){}
      }
      if(inp.getAttribute && inp.getAttribute('onclick')){
        // update onclick removeRow('row_X')
        const oc = inp.getAttribute('onclick');
        inp.setAttribute('onclick', oc.replace(/row_\d+/, 'row_' + idx));
      }
    });
    idx++;
    speciesCount++;
  });
  recalc();
}
function computeFlowFactor(b43){
  if(!isFinite(b43)||b43<=0) return 2;
  if(b43<1) return 2.7;
  if(b43<2) return 3.4;
  if(b43<3) return 4.1;
  if(b43<4) return 4.8;
  if(b43<5) return 5.5;
  if(b43<6) return 6.2;
  if(b43<7) return 6.9;
  return 7.5;
}

function filterPercent(ft){
  if(ft==="Canister") return 15;
  if(ft==="Cascada") return 22;
  if(ft==="Sump") return 5;
  if(ft==="Interno") return 27;
  return 30;
}

function plantationPercent(p){
  if(p==="Sin plantación") return 0;
  if(p==="Plantación moderada") return -15;
  if(p==="Plantación intensiva") return -30;
  return 0;
}

function correctionMultiplier(c){
  if(c==="Sin Corrección") return 1;
  if(c==="Corrección Moderada") return 1.1;
  if(c==="Corrección Alta") return 1.2;
  return 1;
}

function recalc(){
  // volumes
  const L=Number(document.getElementById('length').value)||0;
  const W=Number(document.getElementById('width').value)||0;
  const H=Number(document.getElementById('height').value)||0;
  const substrate_cm=Number(document.getElementById('substrate').value)||0;
  const decor=Number(document.getElementById('decor').value)||0;
  const volGross=(L*W*H)/1000;
  const volSubstrate=(L*W*substrate_cm)/1000+decor;
  const volNet=volGross-volSubstrate;
  document.getElementById('volGross').innerText=volGross.toFixed(2);
  document.getElementById('volSubstrate').innerText=volSubstrate.toFixed(2);
  document.getElementById('volNet').innerText=volNet.toFixed(2);

  // biomassa per row
  let totalBio=0;
  for(let i=1;i<=maxSpecies;i++){
    const row=document.getElementById('row_'+i);
    if(!row) continue;
    const qty=Number(document.getElementById(`qty_${i}`).value)||0;
    const len=Number(document.getElementById(`len_${i}`).value)||0;
    const A=Number(document.getElementById(`A_${i}`).value)||0;
    const B=Number(document.getElementById(`B_${i}`).value)||0;
    let bio=0;
  // modifico decimales
    if(qty>0 && A>0 && B>0 && len>0) bio=Math.round(qty*A*Math.pow(len,B));
    const bioEl=document.getElementById(`bio_${i}`);
    if(bioEl) bioEl.innerText=bio;
  // alineado al centro  
    bioEl.style.textAlign = "center";
    totalBio+=bio;
  }

  document.getElementById('biomassTotal').innerText=totalBio.toFixed(2);
  const b41=volNet||0.0000001;
  const b42=totalBio;
  const b43=b42/b41;
  document.getElementById('biomassPerL').innerText=(b43).toFixed(2);

  const b44=computeFlowFactor(b43);
  document.getElementById('flowFactor').innerText=b44;

  const b45=(Number(document.getElementById('temp').value)||0)>27 ? ((Number(document.getElementById('temp').value)||0)-27)*3 : 0;
  const b46=(Number(document.getElementById('ph').value)||0)<6.5 ? 30 : 0;
  const meals=Number(document.getElementById('meals').value)||0;
  const b47=meals===1?0:(meals-1)*5;
  const b48=plantationPercent(document.getElementById('plantation').value);
  const b49=(Number(document.getElementById('lift').value)||0)/30*10;
  const b50=filterPercent(document.getElementById('filterType').value);

  const b51=b41*b44;
  const b52=b51*(1+b45/100)*(1+b46/100)*(1+b47/100)*(1+b48/100)*(1+b49/100)*(1+b50/100)*correctionMultiplier(document.getElementById('correction').value);

  // rotations
  const rotCandidate=b52/b41;

  const rotMinMax=Math.min(
    10,
    Math.max(
      2,
      1.5*b43+0.5*correctionMultiplier(document.getElementById('correction').value) - 0.3*plantationPercent(document.getElementById('plantation').value)
    )
  );

  const b53=Math.min(rotCandidate,rotMinMax);

  document.getElementById('flowBase').innerText=b51.toFixed(2);
  document.getElementById('flowReal').innerText=b52.toFixed(2);
  document.getElementById('rotations').innerText=b53.toFixed(2);

  // observations 
  let obs="";
  if(Number(document.getElementById('ph').value)<6.5){
    obs="pH muy bajo: Nitrospiras pueden verse afectadas. Revisa correcciones de pH.";
  }
  else if(Number(document.getElementById('temp').value)<22){
    obs="Temperatura baja: por debajo de 22 °C la mayoría de especies tropicales entran en estrés. Ajusta el calentador.";
  }
  else{
    obs="Sistema equilibrado. Mantén monitoreo regular, Amoníaco (NH3/NH4) y Nitritos (NO2)=0; Nitratos (NO3) <20-30ppm.";
  }
  document.getElementById('observations').innerText=obs;
  // call bio calculation
  computeBio();
}

function resetAll() {
  try {
    // efecto visual
    const wrap = document.getElementById('wrapBox');
    wrap.classList.remove('fade-reset');
    void wrap.offsetWidth;
    wrap.classList.add('fade-reset');

    // reset inputs numéricos
    document.querySelectorAll('input[type="number"]').forEach(el => {
      el.value = "";
    });

    // reset selects
    document.querySelectorAll('select').forEach(s => {
      s.selectedIndex = 0;
    });

    // borrar especies totalmente
    const tbody = document.getElementById('speciesBody');
    while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

    // reiniciar contador
    speciesCount = 0;

    // limpiar resultados
    document.getElementById('volGross').innerText = "-";
    document.getElementById('volSubstrate').innerText = "-";
    document.getElementById('volNet').innerText = "-";
    document.getElementById('biomassTotal').innerText = "-";
    document.getElementById('biomassPerL').innerText = "-";
    document.getElementById('flowFactor').innerText = "-";
    document.getElementById('flowBase').innerText = "-";
    document.getElementById('flowReal').innerText = "-";
    document.getElementById('rotations').innerText = "-";
    document.getElementById('bioSurface').innerText = "-";
    document.getElementById('bioVolume').innerText = "-";
    document.getElementById('observations').innerText = "-";

    // recalcular en limpio
    recalc();

  } catch (e) {
    console.error("resetAll ERROR:", e);
  }
}


function attachRecalcListeners(){
  const ids=['length','width','height','substrate','decor','temp','ph','meals','plantation','filterType','lift','correction','feedFactor','safetyFactor','mediaType'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el){ el.addEventListener('input',recalc); el.addEventListener('change',recalc); }
  });
  document.getElementById('speciesSelect').addEventListener('change',()=>{});
}

document.addEventListener('DOMContentLoaded',()=>{
  populateSelect();
  document.getElementById('addSpecies').addEventListener('click',()=>addSpeciesRow(document.getElementById('speciesSelect').value,false));
  document.getElementById('resetBtn').addEventListener('click',resetAll);
  attachRecalcListeners();
  recalc();
});

window.addEventListener("load",()=>{ resetAll(); });


// --- CÁLCULO BIOFILTRACIÓN: superficie y volumen en mL ---
function computeBio() {
  try {
    // gather parameters
    const feedFactor = Number(document.getElementById('feedFactor')?.value) || 1;
    const safetyFactor = parseFloat(document.getElementById('safetyFactor')?.value.replace(",", ".")) || 1;
    const mediaType = Number(document.getElementById('mediaType')?.value) || 700;

    // accumulate S according to: S = sum_over_species [ qty * (A * L^B * 0.02 * feedFactor * safetyFactor * 10) ]
    let S = 0;
    let any = false;
    for (let i = 1; i <= maxSpecies; i++) {
      const row = document.getElementById('row_' + i);
      if (!row) continue;
      const qty = Number(document.getElementById(`qty_${i}`).value) || 0;
      const len = Number(document.getElementById(`len_${i}`).value) || 0;
      const A = Number(document.getElementById(`A_${i}`).value) || 0;
      const B = Number(document.getElementById(`B_${i}`).value) || 0;
      if (qty > 0 && len > 0 && A > 0 && B > 0) {
        any = true;
        const base = A * Math.pow(len, B);
        const s_i = qty * (base * 0.03 * feedFactor * safetyFactor * 10);
        S += s_i;
      }
    }

    if (!any || S <= 0) {
      if (document.getElementById('bioSurface')) document.getElementById('bioSurface').innerText = '-';
      if (document.getElementById('bioVolume')) document.getElementById('bioVolume').innerText = '-';
      return;
    }

    const V_ml = (S * 1000) / mediaType; // mL
    if (document.getElementById('bioSurface')) document.getElementById('bioSurface').innerText = S.toFixed(2);
    if (document.getElementById('bioVolume')) document.getElementById('bioVolume').innerText = V_ml.toFixed(2);
  } catch (e) {
    console.error('computeBio error', e);
  }
}

</script>
<footer style="text-align:center; font-size:14px; margin-top:25px;">
  © 2025 Tu Acuario en Casa. Todos los derechos reservados
</footer>
</body>
</html>



